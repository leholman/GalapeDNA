colSums(U_fishdat_b)
fishdat_b <- cbind(t(U_fishdat_b),t(E_fishdat_b))
fishdat_b_collapsed <- t(collapseNoMismatch(fishdat_b))
fishdat_collapsed <- fishdat_b_collapsed/100000000
colSums(fishdat_collapsed)
U_fishdat_p <-prop.table(as.matrix(U_fishdat[,match(colnames(E_fishdat),colnames(U_fishdat))]),2)
U_fishdat_b <- U_fishdat_p*100000000
E_fishdat_p <-prop.table(as.matrix(E_fishdat),2)
E_fishdat_b <- E_fishdat_p*100000000
colSums(E_fishdat_b)
colSums(U_fishdat_b)
fishdat_b <- cbind(t(U_fishdat_b),t(E_fishdat_b))
fishdat_b_collapsed <- t(collapseNoMismatch(fishdat_b))
fishdat_collapsed <- fishdat_b_collapsed/200000000
colSums(fishdat_collapsed)
fishdat_RP <- cbind(t(U_fishdat_p),t(E_fishdat_p))
rowSum(fishdat_RP)
rowSums(fishdat_RP)
fishdat_RP_collapsed <- t(collapseNoMismatch(fishdat_RP))
colSums(fishdat_RP_collapsed)
#first we make a relative abundance data (p)
U_fishdat_p <-prop.table(as.matrix(U_fishdat[,match(colnames(E_fishdat),colnames(U_fishdat))]),2)
E_fishdat_p <-prop.table(as.matrix(E_fishdat),2)
colSums(E_fishdat_p)
colSums(U_fishdat_p)
#lets check!
colSums(E_fishdat_p)
colSums(U_fishdat_p)
fishdat_p <- cbind(t(U_fishdat_p),t(E_fishdat_p))
fishdat_p_collapsed <- t(collapseNoMismatch(fishdat_p))
fishdat_collapsed <- fishdat_p_collapsed/2
colSums(fishdat_collapsed)
colSums(fishdat_RP_collapsed)
View(fishdat_collapsed)
masterTAX <- read.csv("taxonomy/MasterAssignments.csv")
#Here we are first reassembling the datasets so they have the ASV seq as the row name
U_fishdat <- read.csv("cleandata/Cleaned.MiFish_U.dada2.lulu.csv",row.names = 1)
U_masterTAX <-masterTAX[substr(masterTAX$Index,1,1)=="U",]
U_ASVs <- U_masterTAX$Sequence[match(row.names(U_fishdat),U_masterTAX$ID)]
rownames(U_fishdat) <- U_ASVs
E_fishdat <- read.csv("cleandata/Cleaned.MiFish_E.dada2.lulu.csv",row.names = 1)
E_masterTAX <-masterTAX[substr(masterTAX$Index,1,1)=="E",]
E_ASVs <- E_masterTAX$Sequence[match(row.names(E_fishdat),E_masterTAX$ID)]
rownames(E_fishdat) <- E_ASVs
#first we make a relative abundance data (p)
U_fishdat_p <-prop.table(as.matrix(U_fishdat[,match(colnames(E_fishdat),colnames(U_fishdat))]),2)
E_fishdat_p <-prop.table(as.matrix(E_fishdat),2)
#lets check!
colSums(E_fishdat_p)
colSums(U_fishdat_p)
fishdat_p <- cbind(t(U_fishdat_p),t(E_fishdat_p))
fishdat_p_collapsed <- t(collapseNoMismatch(fishdat_p))
library("metabarTOAD")
library("vegan")
library("Biostrings")
library("RColorBrewer")
library("seqinr")
library("sp")
library("dada2")
fishdat_p_collapsed <- t(collapseNoMismatch(fishdat_p))
fishdat_collapsed <- fishdat_p_collapsed/2
colSums(fishdat_collapsed)
View(fishdat_collapsed)
rownames(fishdat_collapsed)
?match()
?match
View(masterTAX)
match(rownames(fishdat_collapsed),masterTAX$Sequence)
masterTAX_merged <- masterTAX[match(rownames(fishdat_collapsed),masterTAX$Sequence),]
str(fishdat_p_collapsed)
fishdat_p_collapsed <- as.data.frame(fishdat_p_collapsed)
View(fishdat_p_collapsed)
write.csv(fishdat_p_collapsed,"testDAT.csv")
write.csv(masterTAX_merged,"testTAX.csv")
fishdat_p_collapsed_wTAX <- cbind(as.data.frame(fishdat_p_collapsed),masterTAX_merged)
View(fishdat_p_collapsed_wTAX)
rownames(masterTAX_merged)
View(masterTAX_merged)
rownames(fishdat_p_collapsed_wTAX)
rownames(fishdat_p_collapsed_wTAX)==fishdat_p_collapsed_wTAX$Sequence
fishdat_p_collapsed_wTAX_raw <- cbind(as.data.frame(fishdat_p_collapsed),masterTAX_merged)
fishdat_p_collapsed_wTAX_1 <- fishdat_p_collapsed_wTAX_raw[fishdat_p_collapsed_wTAX_raw$Assign.Category!="E"]
fishdat_p_collapsed_wTAX_1 <- fishdat_p_collapsed_wTAX_raw[fishdat_p_collapsed_wTAX_raw$Assign.Category!="E",]
domestics <-c("Bos","Bos taurus","Canis lupus familiaris","Capra hircus","Equus","Gallus","Meleagris gallopavo","Sus scrofa","Homo sapiens")
domestics %in% fishdat_p_collapsed_wTAX_raw$Assign.Assigment
fishdat_p_collapsed_wTAX_raw$Assign.Assigment %in% domestics
fishdat_p_collapsed_wTAX_raw$Assign.Assigment %!in% domestics
fishdat_p_collapsed_wTAX_raw$Assign.Assigment !%in% domestics
!(fishdat_p_collapsed_wTAX_raw$Assign.Assigment %in% domestics)
fishdat_p_collapsed_wTAX_2 <- fishdat_p_collapsed_wTAX_1[!(fishdat_p_collapsed_wTAX_1$Assign.Assigment %in% domestics),]
View(fishdat_p_collapsed_wTAX_2)
domestics <-c("Bos","Bos taurus","Canis lupus familiaris","Capra hircus","Equus","Gallus gallus","Gallus","Meleagris gallopavo","Sus scrofa","Homo sapiens")
fishdat_p_collapsed_wTAX_2 <- fishdat_p_collapsed_wTAX_1[!(fishdat_p_collapsed_wTAX_1$Assign.Assigment %in% domestics),]
View(fishdat_p_collapsed_wTAX_2)
fishdat_p_collapsed_wTAX_2G <- fishdat_p_collapsed_wTAX_2[fishdat_p_collapsed_wTAX_2$Assign.Category=="G"]
fishdat_p_collapsed_wTAX_2G <- fishdat_p_collapsed_wTAX_2[fishdat_p_collapsed_wTAX_2$Assign.Category=="G",]
View(fishdat_p_collapsed_wTAX_2G)
fishdat_p_collapsed_wTAX_2G.test <- aggregate(.~Assign.Assignment,data=fishdat_p_collapsed_wTAX_2G,FUN=sum)
fishdat_p_collapsed_wTAX_2G.test <- aggregate(.~fishdat_p_collapsed_wTAX_2G$Assign.Assigment,data=fishdat_p_collapsed_wTAX_2G,FUN=sum)
fishdat_p_collapsed_wTAX_2G <- fishdat_p_collapsed_wTAX_2[fishdat_p_collapsed_wTAX_2$Assign.Category=="G",1:69]
fishdat_p_collapsed_wTAX_2G.test <- aggregate(.~fishdat_p_collapsed_wTAX_2G$Assign.Assigment,data=fishdat_p_collapsed_wTAX_2G,FUN=sum)
fishdat_p_collapsed_wTAX_2G.test <- aggregate(.~fishdat_p_collapsed_wTAX_2G$Assign.Assigment,data=fishdat_p_collapsed_wTAX_2G[,1:69],FUN=sum)
fishdat_p_collapsed_wTAX_2G <- fishdat_p_collapsed_wTAX_2[fishdat_p_collapsed_wTAX_2$Assign.Category=="G",]
fishdat_p_collapsed_wTAX_2G.test <- aggregate(.~fishdat_p_collapsed_wTAX_2G$Assign.Assigment,data=fishdat_p_collapsed_wTAX_2G[,1:69],FUN=sum)
View(fishdat_p_collapsed_wTAX_2G.test)
aggregate
for spp in unique(fishdat_p_collapsed_wTAX_2G$Assign.Assigment){
for (spp in unique(fishdat_p_collapsed_wTAX_2G$Assign.Assigment)){
print(spp)
}
View(fishdat_p_collapsed_wTAX_2G)
fishdat_p_collapsed_wTAX_2$Assign.Assigment
fishdat_p_collapsed_wTAX_2$Assign.Assigment[fishdat_p_collapsed_wTAX_2$Assign.Category=="G"]
unique(fishdat_p_collapsed_wTAX_2$Assign.Assigment[fishdat_p_collapsed_wTAX_2$Assign.Category=="G"])
name <- ""Zalophus wollebaeki""
name <- "Zalophus wollebaeki"
as.character(fishdat_p_collapsed_wTAX_2$Index2[fishdat_p_collapsed_wTAX_2$Assign.Assigment==name])
fishdat_p_collapsed_wTAX_2$Index2[fishdat_p_collapsed_wTAX_2$Assign.Assigment==name]
fishdat_p_collapsed_wTAX_2$Index2[fishdat_p_collapsed_wTAX_2$Assign.Assigment==name & fishdat_p_collapsed_wTAX_2$Assign.Category=="G"]
collapseOTUs <- fishdat_p_collapsed_wTAX_2$Index2[fishdat_p_collapsed_wTAX_2$Assign.Assigment==name & fishdat_p_collapsed_wTAX_2$Assign.Category=="G"]
match(collapseOTUs,fishdat_p_collapsed_wTAX_2$Index2)
MotherOTU <- names(sort(rowSums(fishdat_p_collapsed_wTAX_2[match(collapseOTUs,fishdat_p_collapsed_wTAX_2$Index2),1:69]),decreasing = TRUE))[1]
sort(rowSums(fishdat_p_collapsed_wTAX_2[match(collapseOTUs,fishdat_p_collapsed_wTAX_2$Index2),1:69]),decreasing = TRUE)
collapseOTUs <- rownames(fishdat_p_collapsed_wTAX_2[fishdat_p_collapsed_wTAX_2$Assign.Assigment==name & fishdat_p_collapsed_wTAX_2$Assign.Category=="G"])
collapseOTUs <- rownames(fishdat_p_collapsed_wTAX_2[fishdat_p_collapsed_wTAX_2$Assign.Assigment==name & fishdat_p_collapsed_wTAX_2$Assign.Category=="G",])
collapseOTUs <- rownames(fishdat_p_collapsed_wTAX_2[fishdat_p_collapsed_wTAX_2$Assign.Assigment==name & fishdat_p_collapsed_wTAX_2$Assign.Category=="G",])
MotherOTU <- sort(rowSums(fishdat_p_collapsed_wTAX_2[match(collapseOTUs,fishdat_p_collapsed_wTAX_2$Index2),1:69]),decreasing = TRUE))[1]
MotherOTU <- sort(rowSums(fishdat_p_collapsed_wTAX_2[match(collapseOTUs,fishdat_p_collapsed_wTAX_2$Index2),1:69]),decreasing = TRUE)[1]
collapseOTUs <- collapseOTUs[-grep(MotherOTU,collapseOTUs)]
collapseOTUs <- rownames(fishdat_p_collapsed_wTAX_2[fishdat_p_collapsed_wTAX_2$Assign.Assigment==name & fishdat_p_collapsed_wTAX_2$Assign.Category=="G",])
MotherOTU <- sort(rowSums(fishdat_p_collapsed_wTAX_2[match(collapseOTUs,fishdat_p_collapsed_wTAX_2$Index2),1:69]),decreasing = TRUE)[1]
collapseOTUs <- rownames(fishdat_p_collapsed_wTAX_2[fishdat_p_collapsed_wTAX_2$Assign.Assigment==name & fishdat_p_collapsed_wTAX_2$Assign.Category=="G",])
MotherOTU <- rownames(sort(rowSums(fishdat_p_collapsed_wTAX_2[match(collapseOTUs,fishdat_p_collapsed_wTAX_2$Index2),1:69]),decreasing = TRUE))[1]
sort(rowSums(fishdat_p_collapsed_wTAX_2[match(collapseOTUs,fishdat_p_collapsed_wTAX_2$Index2),1:69]),decreasing = TRUE)
collapseOTUs <- rownames(fishdat_p_collapsed_wTAX_2[fishdat_p_collapsed_wTAX_2$Assign.Assigment==name & fishdat_p_collapsed_wTAX_2$Assign.Category=="G",])
MotherOTU <- rownames(sort(rowSums(fishdat_p_collapsed_wTAX_2[collapseOTUs,1:69]),decreasing = TRUE))[1]
fishdat_p_collapsed_wTAX_2[collapseOTUs,1:69]
rowSums(fishdat_p_collapsed_wTAX_2[collapseOTUs,1:69]),decreasing = TRUE
rowSums(fishdat_p_collapsed_wTAX_2[collapseOTUs,1:69]),decreasing = TRUE)
MotherOTU <- rownames(sort(rowSums(fishdat_p_collapsed_wTAX_2[collapseOTUs,1:69],decreasing = TRUE)))[1]
fishdat_p_collapsed_wTAX_2[collapseOTUs,1:69]
rowSums(fishdat_p_collapsed_wTAX_2[collapseOTUs,1:69],decreasing = TRUE)
rowSums(fishdat_p_collapsed_wTAX_2[collapseOTUs,1:69])
sort(rowSums(fishdat_p_collapsed_wTAX_2[collapseOTUs,1:69]),decreasing = TRUE)
rownames(sort(rowSums(fishdat_p_collapsed_wTAX_2[collapseOTUs,1:69]),decreasing = TRUE))
names(sort(rowSums(fishdat_p_collapsed_wTAX_2[collapseOTUs,1:69]),decreasing = TRUE))
collapseOTUs <- rownames(fishdat_p_collapsed_wTAX_2[fishdat_p_collapsed_wTAX_2$Assign.Assigment==name & fishdat_p_collapsed_wTAX_2$Assign.Category=="G",])
MotherOTU <- names(sort(rowSums(fishdat_p_collapsed_wTAX_2[collapseOTUs,1:69]),decreasing = TRUE))[1]
collapseOTUs <- collapseOTUs[-grep(MotherOTU,collapseOTUs)]
fishdat_p_collapsed_wTAX_2G <- fishdat_p_collapsed_wTAX_2[fishdat_p_collapsed_wTAX_2$Assign.Category=="G",]
for (name in unique(fishdat_p_collapsed_wTAX_2$Assign.Assigment[fishdat_p_collapsed_wTAX_2$Assign.Category=="G"])){
collapseOTUs <- rownames(fishdat_p_collapsed_wTAX_2[fishdat_p_collapsed_wTAX_2$Assign.Assigment==name & fishdat_p_collapsed_wTAX_2$Assign.Category=="G",])
if(length(collapseOTUs)==1){next}else{
MotherOTU <- names(sort(rowSums(fishdat_p_collapsed_wTAX_2[collapseOTUs,1:69]),decreasing = TRUE))[1]
collapseOTUs <- collapseOTUs[-grep(MotherOTU,collapseOTUs)]
fishdat_p_collapsed_wTAX_2[MotherOTU,] <- fishdat_p_collapsed_wTAX_2[MotherOTU,] + colSums(fishdat_p_collapsed_wTAX_2[collapseOTUs,])
fishdat_p_collapsed_wTAX_2 <- fishdat_p_collapsed_wTAX_2[-match(collapseOTUs,rownames(fishdat_p_collapsed_wTAX_2)),]
}
}
for (name in unique(fishdat_p_collapsed_wTAX_2$Assign.Assigment[fishdat_p_collapsed_wTAX_2$Assign.Category=="G"])){
collapseOTUs <- rownames(fishdat_p_collapsed_wTAX_2[fishdat_p_collapsed_wTAX_2$Assign.Assigment==name & fishdat_p_collapsed_wTAX_2$Assign.Category=="G",])
if(length(collapseOTUs)==1){next}else{
MotherOTU <- names(sort(rowSums(fishdat_p_collapsed_wTAX_2[collapseOTUs,1:69]),decreasing = TRUE))[1]
collapseOTUs <- collapseOTUs[-grep(MotherOTU,collapseOTUs)]
fishdat_p_collapsed_wTAX_2[MotherOTU,1:69] <- fishdat_p_collapsed_wTAX_2[MotherOTU,1:69] + colSums(fishdat_p_collapsed_wTAX_2[collapseOTUs,1:69])
fishdat_p_collapsed_wTAX_2 <- fishdat_p_collapsed_wTAX_2[-match(collapseOTUs,rownames(fishdat_p_collapsed_wTAX_2)),]
}
}
fishdat_p_collapsed_wTAX_2 <- fishdat_p_collapsed_wTAX_1[!(fishdat_p_collapsed_wTAX_1$Assign.Assigment %in% domestics),]
fishdat_p_collapsed_wTAX_2G <- fishdat_p_collapsed_wTAX_2[fishdat_p_collapsed_wTAX_2$Assign.Category=="G",]
for (name in unique(fishdat_p_collapsed_wTAX_2$Assign.Assigment[fishdat_p_collapsed_wTAX_2$Assign.Category=="G"])){
collapseOTUs <- rownames(fishdat_p_collapsed_wTAX_2[fishdat_p_collapsed_wTAX_2$Assign.Assigment==name & fishdat_p_collapsed_wTAX_2$Assign.Category=="G",])
if(length(collapseOTUs)==1){next}else{
MotherOTU <- names(sort(rowSums(fishdat_p_collapsed_wTAX_2[collapseOTUs,1:69]),decreasing = TRUE))[1]
collapseOTUs <- collapseOTUs[-grep(MotherOTU,collapseOTUs)]
fishdat_p_collapsed_wTAX_2[MotherOTU,1:69] <- fishdat_p_collapsed_wTAX_2[MotherOTU,1:69] + colSums(fishdat_p_collapsed_wTAX_2[collapseOTUs,1:69])
fishdat_p_collapsed_wTAX_2 <- fishdat_p_collapsed_wTAX_2[-match(collapseOTUs,rownames(fishdat_p_collapsed_wTAX_2)),]
}
}
fishdat_p_collapsed_wTAX_3 <- fishdat_p_collapsed_wTAX_2
#this code sums the incidence data for good quality hits to the same species
for (name in unique(fishdat_p_collapsed_wTAX_3$Assign.Assigment[fishdat_p_collapsed_wTAX_3$Assign.Category=="G"])){
collapseOTUs <- rownames(fishdat_p_collapsed_wTAX_3[fishdat_p_collapsed_wTAX_3$Assign.Assigment==name & fishdat_p_collapsed_wTAX_3$Assign.Category=="G",])
if(length(collapseOTUs)==1){next}else{
MotherOTU <- names(sort(rowSums(fishdat_p_collapsed_wTAX_3[collapseOTUs,1:69]),decreasing = TRUE))[1]
collapseOTUs <- collapseOTUs[-grep(MotherOTU,collapseOTUs)]
fishdat_p_collapsed_wTAX_3[MotherOTU,1:69] <- fishdat_p_collapsed_wTAX_3[MotherOTU,1:69] + colSums(fishdat_p_collapsed_wTAX_3[collapseOTUs,1:69])
fishdat_p_collapsed_wTAX_3 <- fishdat_p_collapsed_wTAX_3[-match(collapseOTUs,rownames(fishdat_p_collapsed_wTAX_3)),]
}
}
fishdat_p_collapsed_wTAX_2 <- fishdat_p_collapsed_wTAX_1[!(fishdat_p_collapsed_wTAX_1$Assign.Assigment %in% domestics),]
fishdat_p_collapsed_wTAX_3 <- fishdat_p_collapsed_wTAX_2
#this code sums the incidence data for good quality hits to the same species
for (name in unique(fishdat_p_collapsed_wTAX_3$Assign.Assigment[fishdat_p_collapsed_wTAX_3$Assign.Category=="G"])){
collapseOTUs <- rownames(fishdat_p_collapsed_wTAX_3[fishdat_p_collapsed_wTAX_3$Assign.Assigment==name & fishdat_p_collapsed_wTAX_3$Assign.Category=="G",])
if(length(collapseOTUs)==1){next}else{
MotherOTU <- names(sort(rowSums(fishdat_p_collapsed_wTAX_3[collapseOTUs,1:69]),decreasing = TRUE))[1]
collapseOTUs <- collapseOTUs[-grep(MotherOTU,collapseOTUs)]
fishdat_p_collapsed_wTAX_3[MotherOTU,1:69] <- fishdat_p_collapsed_wTAX_3[MotherOTU,1:69] + colSums(fishdat_p_collapsed_wTAX_3[collapseOTUs,1:69])
fishdat_p_collapsed_wTAX_3 <- fishdat_p_collapsed_wTAX_3[-match(collapseOTUs,rownames(fishdat_p_collapsed_wTAX_3)),]
}
}
View(fishdat_p_collapsed_wTAX_3)
fishdat_p_collapsed_wTAX_3$B.phylum
unique(fishdat_p_collapsed_wTAX_3$B.phylum)
unique(fishdat_p_collapsed_wTAX_3$B.class)
test <- fishdat_p_collapsed_wTAX_3[fishdat_p_collapsed_wTAX_3$B.class=="" |
fishdat_p_collapsed_wTAX_3$B.class== NA |
fishdat_p_collapsed_wTAX_3$B.class=="Actinopteri" |
fishdat_p_collapsed_wTAX_3$B.class=="Chondrichthyes", ]
View(test)
test <- fishdat_p_collapsed_wTAX_3[fishdat_p_collapsed_wTAX_3$B.class=="" |
fishdat_p_collapsed_wTAX_3$B.class=="Actinopteri" |
fishdat_p_collapsed_wTAX_3$B.class=="Chondrichthyes", ]
View(test)
View(fishdat_p_collapsed_wTAX_3)
fishdat_p_collapsed_wTAX_3$B.class=="" |fishdat_p_collapsed_wTAX_3$B.class==""| fishdat_p_collapsed_wTAX_3$B.class=="" fishdat_p_collapsed_wTAX_3$B.class==""
fishdat_p_collapsed_wTAX_3$B.class==""
is.null(fishdat_p_collapsed_wTAX_3$B.class)
##
library("metabarTOAD")
library("vegan")
library("Biostrings")
library("RColorBrewer")
library("seqinr")
library("sp")
library("dada2")
#### Settings and Setup####
##Get metadata
metadat <- read.csv("metadata.csv")
metadat.site <- read.csv("metadata.site.csv")
#Set some variables
minreads <- 3
items <- NULL
#Set the seed
set.seed("123456")
palette(brewer.pal(12, "Set3"))
#Change the location to sensible numbers
metadat.site$lat2 <- as.numeric(paste0(ifelse(substr(metadat.site$latitude,1,1)=="S","-",""),substr(metadat.site$latitude,3,4),".",substr(as.character(as.numeric(paste0(substr(metadat.site$latitude,6,7),".",substr(metadat.site$latitude,9,11)))/60),3,20)))
metadat.site$lon2 <- as.numeric(paste0(ifelse(substr(metadat.site$longitude,1,1)=="W","-",""),substr(metadat.site$longitude,4,5),".",substr(as.character(as.numeric(paste0(substr(metadat.site$longitude,8,9),".",substr(metadat.site$longitude,11,13)))/60),3,20)))
write.csv(metadat.site,file = "metadata.site.out.csv")
masterTAX <- read.csv("taxonomy/MasterAssignments.csv")
#combine identical or subset seqs
#Here we are first reassembling the datasets so they have the ASV seq as the row name
U_fishdat <- read.csv("cleandata/Cleaned.MiFish_U.dada2.lulu.csv",row.names = 1)
U_masterTAX <-masterTAX[substr(masterTAX$Index,1,1)=="U",]
U_ASVs <- U_masterTAX$Sequence[match(row.names(U_fishdat),U_masterTAX$ID)]
rownames(U_fishdat) <- U_ASVs
E_fishdat <- read.csv("cleandata/Cleaned.MiFish_E.dada2.lulu.csv",row.names = 1)
E_masterTAX <-masterTAX[substr(masterTAX$Index,1,1)=="E",]
E_ASVs <- E_masterTAX$Sequence[match(row.names(E_fishdat),E_masterTAX$ID)]
rownames(E_fishdat) <- E_ASVs
#Now as the samples have different numbers of reads between each marker we switch to relative abundance and use the dada2 function collapse no mismatch
#first we make a relative abundance data (p)
U_fishdat_p <-prop.table(as.matrix(U_fishdat[,match(colnames(E_fishdat),colnames(U_fishdat))]),2)
E_fishdat_p <-prop.table(as.matrix(E_fishdat),2)
#lets check!
colSums(E_fishdat_p)
colSums(U_fishdat_p)
fishdat_p <- cbind(t(U_fishdat_p),t(E_fishdat_p))
fishdat_p_collapsed <- t(collapseNoMismatch(fishdat_p))
fishdat_collapsed <- fishdat_p_collapsed/2
colSums(fishdat_collapsed)
## Now let's match up the taxonomy
rownames(fishdat_collapsed)
masterTAX_merged <- masterTAX[match(rownames(fishdat_collapsed),masterTAX$Sequence),]
fishdat_p_collapsed_wTAX_raw <- cbind(as.data.frame(fishdat_p_collapsed),masterTAX_merged)
View(masterTAX)
#Get rid of error seqs
fishdat_p_collapsed_wTAX_1 <- fishdat_p_collapsed_wTAX_raw[fishdat_p_collapsed_wTAX_raw$Assign.Category!="E",]
#get rid of the below domestic animals & humans
domestics <-c("Bos","Bos taurus","Canis lupus familiaris","Capra hircus","Equus","Gallus gallus","Gallus","Meleagris gallopavo","Sus scrofa","Homo sapiens")
fishdat_p_collapsed_wTAX_2 <- fishdat_p_collapsed_wTAX_1[!(fishdat_p_collapsed_wTAX_1$Assign.Assigment %in% domestics),]
#combine all 'good' species IDs
fishdat_p_collapsed_wTAX_3 <- fishdat_p_collapsed_wTAX_2
#this code sums the incidence data for good quality hits to the same species
for (name in unique(fishdat_p_collapsed_wTAX_3$Assign.Assigment[fishdat_p_collapsed_wTAX_3$Assign.Category=="G"])){
collapseOTUs <- rownames(fishdat_p_collapsed_wTAX_3[fishdat_p_collapsed_wTAX_3$Assign.Assigment==name & fishdat_p_collapsed_wTAX_3$Assign.Category=="G",])
if(length(collapseOTUs)==1){next}else{
MotherOTU <- names(sort(rowSums(fishdat_p_collapsed_wTAX_3[collapseOTUs,1:69]),decreasing = TRUE))[1]
collapseOTUs <- collapseOTUs[-grep(MotherOTU,collapseOTUs)]
fishdat_p_collapsed_wTAX_3[MotherOTU,1:69] <- fishdat_p_collapsed_wTAX_3[MotherOTU,1:69] + colSums(fishdat_p_collapsed_wTAX_3[collapseOTUs,1:69])
fishdat_p_collapsed_wTAX_3 <- fishdat_p_collapsed_wTAX_3[-match(collapseOTUs,rownames(fishdat_p_collapsed_wTAX_3)),]
}
}
View(fishdat_p_collapsed_wTAX_3)
####====0.1 Packages & Setup====####
library("metabarTOAD")
library("vegan")
library("Biostrings")
library("RColorBrewer")
library("seqinr")
library("sp")
library("dada2")
#### Settings and Setup####
##Get metadata
metadat <- read.csv("metadata.csv")
metadat.site <- read.csv("metadata.site.csv")
#Set some variables
minreads <- 3
items <- NULL
#Set the seed
set.seed("123456")
palette(brewer.pal(12, "Set3"))
#Change the location to sensible numbers
metadat.site$lat2 <- as.numeric(paste0(ifelse(substr(metadat.site$latitude,1,1)=="S","-",""),substr(metadat.site$latitude,3,4),".",substr(as.character(as.numeric(paste0(substr(metadat.site$latitude,6,7),".",substr(metadat.site$latitude,9,11)))/60),3,20)))
metadat.site$lon2 <- as.numeric(paste0(ifelse(substr(metadat.site$longitude,1,1)=="W","-",""),substr(metadat.site$longitude,4,5),".",substr(as.character(as.numeric(paste0(substr(metadat.site$longitude,8,9),".",substr(metadat.site$longitude,11,13)))/60),3,20)))
write.csv(metadat.site,file = "metadata.site.out.csv")
#Lets look at the particle tracking data
#all dat
p.data <- read.csv("/Users/gwm297/GitHubRepos/GalapeDNA/ParticleTracking/AlexData010420.21/1km_new_stats.csv")
#day 3
p.data2 <- p.data[p.data$day=="-3",]
plot(p.data2$area..km.,p.data2$ave_dist)
plot(lm(p.data2$area..km.~p.data2$ave_dist))
##Processing the taxonomy according to a simple blast script
#We need to add the header
Tax.MiFish.E <- read.table(file = "taxonomy/MiFishErawtaxonomy.txt",sep="\t")
names(Tax.MiFish.E) <- c("OTUID","qlen","slen","qcov","qcovhsp","sseqid","bitscore","score","evalue","pctid","qstart","qend","start","send","staxid","sscinames")
write.table(Tax.MiFish.E,"taxonomy/MiFishE.assignment.H.txt",row.names=FALSE,sep="\t", quote = FALSE)
Tax.MiFish.U <- read.table(file = "taxonomy/MiFishUrawtaxonomy.txt",sep="\t")
names(Tax.MiFish.U) <- c("OTUID","qlen","slen","qcov","qcovhsp","sseqid","bitscore","score","evalue","pctid","qstart","qend","start","send","staxid","sscinames")
write.table(Tax.MiFish.U,"taxonomy/MiFishU.assignment.H.txt",row.names=FALSE,sep="\t", quote = FALSE)
MiUassignments <- ParseTaxonomy(blastoutput = "taxonomy/MiFishU.assignment.H.txt",lineages = "taxonomy/ncbi_lineages_2021-01-27.csv.gz",lwrcovpct=90)
masterTAX <- read.csv("taxonomy/MasterAssignments.csv")
#Here we are first reassembling the datasets so they have the ASV seq as the row name
U_fishdat <- read.csv("cleandata/Cleaned.MiFish_U.dada2.lulu.csv",row.names = 1)
U_masterTAX <-masterTAX[substr(masterTAX$Index,1,1)=="U",]
U_ASVs <- U_masterTAX$Sequence[match(row.names(U_fishdat),U_masterTAX$ID)]
rownames(U_fishdat) <- U_ASVs
E_fishdat <- read.csv("cleandata/Cleaned.MiFish_E.dada2.lulu.csv",row.names = 1)
E_masterTAX <-masterTAX[substr(masterTAX$Index,1,1)=="E",]
E_ASVs <- E_masterTAX$Sequence[match(row.names(E_fishdat),E_masterTAX$ID)]
rownames(E_fishdat) <- E_ASVs
#first we make a relative abundance data (p)
U_fishdat_p <-prop.table(as.matrix(U_fishdat[,match(colnames(E_fishdat),colnames(U_fishdat))]),2)
E_fishdat_p <-prop.table(as.matrix(E_fishdat),2)
#lets check!
colSums(E_fishdat_p)
colSums(U_fishdat_p)
fishdat_p <- cbind(t(U_fishdat_p),t(E_fishdat_p))
fishdat_p_collapsed <- t(collapseNoMismatch(fishdat_p))
fishdat_collapsed <- fishdat_p_collapsed/2
colSums(fishdat_collapsed)
rownames(fishdat_collapsed)
masterTAX_merged <- masterTAX[match(rownames(fishdat_collapsed),masterTAX$Sequence),]
fishdat_p_collapsed_wTAX_raw <- cbind(as.data.frame(fishdat_p_collapsed),masterTAX_merged)
fishdat_p_collapsed_wTAX_1 <- fishdat_p_collapsed_wTAX_raw[fishdat_p_collapsed_wTAX_raw$Assign.Category!="E",]
domestics <-c("Bos","Bos taurus","Canis lupus familiaris","Capra hircus","Equus","Gallus gallus","Gallus","Meleagris gallopavo","Sus scrofa","Homo sapiens")
fishdat_p_collapsed_wTAX_2 <- fishdat_p_collapsed_wTAX_1[!(fishdat_p_collapsed_wTAX_1$Assign.Assigment %in% domestics),]
fishdat_p_collapsed_wTAX_3 <- fishdat_p_collapsed_wTAX_2
#this code sums the incidence data for good quality hits to the same species
for (name in unique(fishdat_p_collapsed_wTAX_3$Assign.Assigment[fishdat_p_collapsed_wTAX_3$Assign.Category=="G"])){
collapseOTUs <- rownames(fishdat_p_collapsed_wTAX_3[fishdat_p_collapsed_wTAX_3$Assign.Assigment==name & fishdat_p_collapsed_wTAX_3$Assign.Category=="G",])
if(length(collapseOTUs)==1){next}else{
MotherOTU <- names(sort(rowSums(fishdat_p_collapsed_wTAX_3[collapseOTUs,1:69]),decreasing = TRUE))[1]
collapseOTUs <- collapseOTUs[-grep(MotherOTU,collapseOTUs)]
fishdat_p_collapsed_wTAX_3[MotherOTU,1:69] <- fishdat_p_collapsed_wTAX_3[MotherOTU,1:69] + colSums(fishdat_p_collapsed_wTAX_3[collapseOTUs,1:69])
fishdat_p_collapsed_wTAX_3 <- fishdat_p_collapsed_wTAX_3[-match(collapseOTUs,rownames(fishdat_p_collapsed_wTAX_3)),]
}
}
View(fishdat_p_collapsed_wTAX_3)
unique(fishdat_p_collapsed_wTAX_3$B.class)
write.csv(fishdat_p_collapsed_wTAX_3,"cleandata/Cleaned_Master_wTAX.csv")
test <- fishdat_p_collapsed_wTAX_3[fishdat_p_collapsed_wTAX_3$B.class%in%c("Mamiellophyceae"),]
View(test)
test <- fishdat_p_collapsed_wTAX_3[!(fishdat_p_collapsed_wTAX_3$B.class%in%c("Mammalia","Aves","Lepidosauria","Mamiellophyceae","Demospongiae")),]
View(test)
fishdat_p_collapsed_wTAX_3$B.class%in%c("Mammalia","Aves","Lepidosauria","Mamiellophyceae","Demospongiae")
test <- fishdat_p_collapsed_wTAX_3[(fishdat_p_collapsed_wTAX_3$B.class%in%c("Mammalia","Aves","Lepidosauria","Mamiellophyceae","Demospongiae")),]
View(test)
test <- fishdat_p_collapsed_wTAX_3[!(fishdat_p_collapsed_wTAX_3$B.class%in%c("Mammalia","Aves","Lepidosauria","Mamiellophyceae","Demospongiae")),]
View(test)
#somehow green turtle escapes the non-fish purge
FishOut <- FishOut[!(fishdat_p_collapsed_wTAX_3$B.class==Testudines),]
FishOut <- fishdat_p_collapsed_wTAX_3[!(fishdat_p_collapsed_wTAX_3$B.class%in%c("Mammalia","Aves","Lepidosauria","Mamiellophyceae","Demospongiae")),]
#somehow green turtle escapes the non-fish purge
FishOut <- FishOut[!(fishdat_p_collapsed_wTAX_3$B.class==Testudines),]
#somehow green turtle escapes the non-fish purge
FishOut <- FishOut[!(fishdat_p_collapsed_wTAX_3$B.class=="Testudines"),]
View(FishOut)
FishOut <- fishdat_p_collapsed_wTAX_3[!(fishdat_p_collapsed_wTAX_3$B.class%in%c("Mammalia","Aves","Lepidosauria","Mamiellophyceae","Demospongiae")),]
#somehow green turtle escapes the non-fish purge
FishOut <- FishOut[!(FishOut$B.class=="Testudines"),]
View(FishOut)
FishOut <- fishdat_p_collapsed_wTAX_3[!(fishdat_p_collapsed_wTAX_3$B.class%in%c("Mammalia","Aves","Lepidosauria","Mamiellophyceae","Demospongiae")),]
#somehow green turtle escapes the non-fish purge
FishOut <- FishOut[!(FishOut$B.class=="Testudines"),]
#somehow green turtle escapes the non-fish purge
FishOut <- FishOut[!(FishOut$B.order=="Testudines"),]
View(FishOut)
#
write.csv(FishOut,"cleandata/Cleaned_Fish_wTAX.csv")
##BIRDS
BirdOut <- fishdat_p_collapsed_wTAX_3[fishdat_p_collapsed_wTAX_3$B.class%=="Aves",]
##BIRDS
BirdOut <- fishdat_p_collapsed_wTAX_3[fishdat_p_collapsed_wTAX_3$B.class=="Aves",]
View(BirdOut)
##BIRDS
BirdOut <- fishdat_p_collapsed_wTAX_3[na.omit(fishdat_p_collapsed_wTAX_3$B.class=="Aves"),]
View(BirdOut)
fishdat_p_collapsed_wTAX_3$B.class=="Aves"
match(fishdat_p_collapsed_wTAX_3$B.class,"Aves")
match("Aves",fishdat_p_collapsed_wTAX_3$B.class)
##BIRDS
BirdOut <- fishdat_p_collapsed_wTAX_3[fishdat_p_collapsed_wTAX_3$B.class=="Aves"),]
View(BirdOut)
##BIRDS
BirdOut <- fishdat_p_collapsed_wTAX_3[fishdat_p_collapsed_wTAX_3$B.class=="Aves",]
View(BirdOut)
is.na(BirdOut[,1])
BirdOut  <- BirdOut[is.na(BirdOut[,1]),]
##BIRDS
BirdOut <- fishdat_p_collapsed_wTAX_3[fishdat_p_collapsed_wTAX_3$B.class=="Aves",]
BirdOut  <- BirdOut[!is.na(BirdOut[,1]),]
View(BirdOut)
##MAMMALS
MammOut <- fishdat_p_collapsed_wTAX_3[fishdat_p_collapsed_wTAX_3$B.class=="Mammalia",]
MammOut  <- MammOut[!is.na(MammOut[,1]),]
View(MammOut)
domestics <-c("Bos","Bos taurus","Canis lupus familiaris","Capra hircus","Equus","Felis catus","Gallus gallus","Gallus","Meleagris gallopavo","Sus scrofa","Homo sapiens")
fishdat_p_collapsed_wTAX_2 <- fishdat_p_collapsed_wTAX_1[!(fishdat_p_collapsed_wTAX_1$Assign.Assigment %in% domestics),]
fishdat_p_collapsed_wTAX_3 <- fishdat_p_collapsed_wTAX_2
#this code sums the incidence data for good quality hits to the same species
for (name in unique(fishdat_p_collapsed_wTAX_3$Assign.Assigment[fishdat_p_collapsed_wTAX_3$Assign.Category=="G"])){
collapseOTUs <- rownames(fishdat_p_collapsed_wTAX_3[fishdat_p_collapsed_wTAX_3$Assign.Assigment==name & fishdat_p_collapsed_wTAX_3$Assign.Category=="G",])
if(length(collapseOTUs)==1){next}else{
MotherOTU <- names(sort(rowSums(fishdat_p_collapsed_wTAX_3[collapseOTUs,1:69]),decreasing = TRUE))[1]
collapseOTUs <- collapseOTUs[-grep(MotherOTU,collapseOTUs)]
fishdat_p_collapsed_wTAX_3[MotherOTU,1:69] <- fishdat_p_collapsed_wTAX_3[MotherOTU,1:69] + colSums(fishdat_p_collapsed_wTAX_3[collapseOTUs,1:69])
fishdat_p_collapsed_wTAX_3 <- fishdat_p_collapsed_wTAX_3[-match(collapseOTUs,rownames(fishdat_p_collapsed_wTAX_3)),]
}
}
write.csv(fishdat_p_collapsed_wTAX_3,"cleandata/Cleaned_Master_wTAX.csv")
##FISH
FishOut <- fishdat_p_collapsed_wTAX_3[!(fishdat_p_collapsed_wTAX_3$B.class%in%c("Mammalia","Aves","Lepidosauria","Mamiellophyceae","Demospongiae")),]
#somehow green turtle escapes the non-fish purge
FishOut <- FishOut[!(FishOut$B.order=="Testudines"),]
write.csv(FishOut,"cleandata/Cleaned_Fish_wTAX.csv")
##BIRDS
BirdOut <- fishdat_p_collapsed_wTAX_3[fishdat_p_collapsed_wTAX_3$B.class=="Aves",]
BirdOut  <- BirdOut[!is.na(BirdOut[,1]),]
write.csv(BirdOut,"cleandata/Cleaned_Birds_wTAX.csv")
##MAMMALS
MammOut <- fishdat_p_collapsed_wTAX_3[fishdat_p_collapsed_wTAX_3$B.class=="Mammalia",]
MammOut  <- MammOut[!is.na(MammOut[,1]),]
View(MammOut)
write.csv(MammOut,"cleandata/Cleaned_Mammals_wTAX.csv")
##FISH
FishOut <- fishdat_p_collapsed_wTAX_3[!(fishdat_p_collapsed_wTAX_3$B.class%in%c("Mammalia","Aves","Lepidosauria","Mamiellophyceae","Demospongiae")),]
View(FishOut)
#somehow green turtle escapes the non-fish purge
FishOut <- FishOut[!(FishOut$B.order=="Testudines"),]
View(FishOut)
FishOut$B.order=="Testudines"
(FishOut$B.order=="Testudines")==TRUE
##FISH
FishOut <- fishdat_p_collapsed_wTAX_3[!(fishdat_p_collapsed_wTAX_3$B.class%in%c("Mammalia","Aves","Lepidosauria","Mamiellophyceae","Demospongiae")),]
match("Testudines",FishOut$B.order)
##FISH
FishOut <- fishdat_p_collapsed_wTAX_3[!(fishdat_p_collapsed_wTAX_3$B.class%in%c("Mammalia","Aves","Lepidosauria","Mamiellophyceae","Demospongiae")),]
#somehow green turtle escapes the non-fish purge
FishOut <- FishOut[-match("Testudines",FishOut$B.order),]
View(FishOut)
FishOut[is.na(FishOut)] <- ""
View(FishOut)
FishOut <- fishdat_p_collapsed_wTAX_3[!(fishdat_p_collapsed_wTAX_3$B.class%in%c("Mammalia","Aves","Lepidosauria","Mamiellophyceae","Demospongiae")),]
#somehow green turtle escapes the non-fish purge
FishOut <- FishOut[-match("Testudines",FishOut$B.order),]
FishOut[is.na(FishOut)] <- ""
write.csv(FishOut,"cleandata/Cleaned_Fish_wTAX.csv")
##BIRDS
BirdOut <- fishdat_p_collapsed_wTAX_3[fishdat_p_collapsed_wTAX_3$B.class=="Aves",]
BirdOut  <- BirdOut[!is.na(BirdOut[,1]),]
write.csv(BirdOut,"cleandata/Cleaned_Birds_wTAX.csv")
##MAMMALS
MammOut <- fishdat_p_collapsed_wTAX_3[fishdat_p_collapsed_wTAX_3$B.class=="Mammalia",]
MammOut  <- MammOut[!is.na(MammOut[,1]),]
write.csv(MammOut,"cleandata/Cleaned_Mammals_wTAX.csv")
##OTHERS
##FISH
FishOut <- fishdat_p_collapsed_wTAX_3[!(fishdat_p_collapsed_wTAX_3$B.class%in%c("Mammalia","Aves","Lepidosauria","Mamiellophyceae","Demospongiae")),]
#somehow green turtle escapes the non-fish purge
FishOut <- FishOut[-match("Testudines",FishOut$B.order),]
View(FishOut)
FishOut[is.na(FishOut)] <- ""
write.csv(FishOut,"cleandata/Cleaned_Fish_wTAX.csv")
unique(fishdat_p_collapsed_wTAX_3$B.class)
rownames(FishOut)
match(c(rownames(FishOut),rownames(BirdOut),rownames(MammOut)),rownames(fishdat_p_collapsed_wTAX_3))
fishdat_p_collapsed_wTAX_3[match(c(rownames(FishOut),rownames(BirdOut),rownames(MammOut)),rownames(fishdat_p_collapsed_wTAX_3))]
fishdat_p_collapsed_wTAX_3[match(c(rownames(FishOut),rownames(BirdOut),rownames(MammOut)),rownames(fishdat_p_collapsed_wTAX_3)),]
test <- fishdat_p_collapsed_wTAX_3[match(c(rownames(FishOut),rownames(BirdOut),rownames(MammOut)),rownames(fishdat_p_collapsed_wTAX_3)),]
test <- fishdat_p_collapsed_wTAX_3[-match(c(rownames(FishOut),rownames(BirdOut),rownames(MammOut)),rownames(fishdat_p_collapsed_wTAX_3)),]
View(test)
##FISH
FishOut <- fishdat_p_collapsed_wTAX_3[!(fishdat_p_collapsed_wTAX_3$B.class%in%c("Mammalia","Aves","Lepidosauria","Mamiellophyceae","Demospongiae")),]
#somehow green turtle escapes the non-fish purge
FishOut <- FishOut[-match("Testudines",FishOut$B.order),]
FishOut[is.na(FishOut)] <- ""
write.csv(FishOut,"cleandata/Cleaned_Fish_wTAX.csv")
##BIRDS
BirdOut <- fishdat_p_collapsed_wTAX_3[fishdat_p_collapsed_wTAX_3$B.class=="Aves",]
BirdOut  <- BirdOut[!is.na(BirdOut[,1]),]
write.csv(BirdOut,"cleandata/Cleaned_Birds_wTAX.csv")
##MAMMALS
MammOut <- fishdat_p_collapsed_wTAX_3[fishdat_p_collapsed_wTAX_3$B.class=="Mammalia",]
MammOut  <- MammOut[!is.na(MammOut[,1]),]
write.csv(MammOut,"cleandata/Cleaned_Mammals_wTAX.csv")
##OTHERS
OtherOut <- fishdat_p_collapsed_wTAX_3[-match(c(rownames(FishOut),rownames(BirdOut),rownames(MammOut)),rownames(fishdat_p_collapsed_wTAX_3)),]
write.csv(OtherOut,"cleandata/Cleaned_Others_wTAX.csv")
